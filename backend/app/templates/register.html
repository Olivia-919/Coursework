<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- <meta name="csrf-token" content="{{ csrf_token() }}"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {{ bootstrap.load_css() }}
    <title>{{ title }}</title>
</head>

<body class="bg-light">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb" style="margin-top: 2.5rem">
              <li class="breadcrumb-item"><a href="/">首页</a></li>
              <li class="breadcrumb-item active" aria-current="page">注册账号</li>
            </ol>
          </nav>
        <div class="py-5 text-center">
            <!-- <img class="d-block mx-auto mb-4" src="../assets/brand/bootstrap-solid.svg" alt="" width="72" height="72"> -->
            <h2>注册账号</h2>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-8">
                <form id="register-form" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="name">用户名</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="用户名" required>
                        <small class="text-muted">支持4 ～ 16位的字母、数字和下划线组合</small>
                        <div class="invalid-feedback" style="width: 100%;">
                            请输入有效的用户名
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="password">密码</label>
                        <input type="password" class="form-control" id="password" name="password" placeholder="密码" required>
                        <small class="text-muted">支持6 ～ 20位，包括至少1个大写字母，1个小写字母，1个数字，1个特殊字符</small>
                        <div class="invalid-feedback" style="width: 100%;">
                            请输入有效的密码
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="confirm_pwd">确认密码</label>
                        <input type="password" class="form-control" id="confirm_pwd" placeholder="请确认密码" required>
                        <div class="invalid-feedback" style="width: 100%;">
                            密码不一致
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <label for="sex">性别<span class="text-muted">(可选)</span></label>
                            <select class="custom-select d-block w-100" id="sex" name="sex">
                                <option value="">请选择</option>
                                <option value="1">男</option>
                                <option value="0">女</option>
                            </select>
                        </div>
                    </div>
                    
                    <hr class="mb-4">
                    <button id="register_submit" type="submit" class="btn btn-primary btn-lg btn-block">
                        <span id="submit_loading" class="spinner-border spinner-border-sm" style="display: none;"></span>
                        提交
                    </button>
                    <div id="message_wrap" class="mt-3"></div>
                    
                </form>
            </div>
        </div>

        <footer class="my-5 pt-5 text-muted text-center text-small">
        </footer>
    </div>

    <script>
        const _token = '{{ csrf_token() }}';
        window.onload = function() {
            const form = document.getElementById('register-form');
            const name_reg = /^[a-zA-Z0-9_-]{4,16}$/;
            const pwd_reg = /^.*(?=.{6,20})(?=.*\d)(?=.*[A-Z])(?=.*[a-z])(?=.*[!@#$%^&*? ]).*$/;

            function validateForm() {
                return new Promise((resolve, reject) => {
                    let flag = true;
                    if (form.checkValidity() === false) {
                        flag = false;
                    }

                    const nameVal = $('#name').val();
                    const pwdVal = $('#password').val();
                    const confirmVal = $('#confirm_pwd').val()

                    if (nameVal && name_reg.test(nameVal)) {
                        $('#name').removeClass('is-invalid');
                    } else {
                        $('#name').addClass('is-invalid');
                        flag = false;
                    }

                    if (pwdVal && pwd_reg.test(pwdVal)) {
                        $('#password').removeClass('is-invalid');
                    } else {
                        $('#password').addClass('is-invalid');
                        flag = false;
                    }

                    if (confirmVal && confirmVal === pwdVal) {
                        $('#confirm_pwd').removeClass('is-invalid');
                    } else {
                        $('#confirm_pwd').addClass('is-invalid');
                        flag = false;
                    }

                    if (flag) {
                        resolve()
                    } else {
                        reject();
                    }
                })
            }

            $('#register_submit').click(function(e) {
                e.preventDefault();
                validateForm()
                    .then(() => {
                        $('#register_submit').attr('disabled', true);
                        $('#submit_loading').css('display', 'inline-block');
                        const fd = new FormData(form);
                        if (!fd.get('sex')) {
                            fd.delete('sex');
                        }
                        setTimeout(function() {
                            fetch(
                                '/api/register',
                                {
                                    method: 'POST',
                                    body: fd,
                                    headers: {
                                        'X-CSRFToken': _token
                                    }
                                }
                            )
                                .then(r => r.json())
                                .then(r => {
                                    $('#submit_loading').css('display', 'none');
                                    $('#register_submit').attr('disabled', false);
                                    if (r.success) {
                                        // 跳到首页 window.location.href = '/';
                                        $('#message_wrap').html('<div class="alert alert-success" role="alert">注册成功！</div>');
                                    }
                                })
                        }, 1000)
                    })
            })
        }
    </script>

    {{ bootstrap.load_js() }}
</body>

</html>